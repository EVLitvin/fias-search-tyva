-- можно ли совместить pg_trgm и to_tsquery(?) или websearch_to_tsquery(?) или plainto_tsquery(?) или phraseto_tsquery(?)
-- как добавить дом
-- как добавить objectType и objectName для каждого кто в path иерархии
-- как сделать динамичский выпадающий список при наборе

-- поиск aao.name ILIKE '%' || ? || '%'
SELECT aao.typename    AS objectType,
       aao.name        AS objectName,
       aao.objectid    AS objectID,
       aao.objectguid  AS objectGUID,
       amh.parentobjid AS objectParent,
       aao.isactive    AS objectActiveStatus,
       aao.isactual    AS objectActualStatus,
       aao.level       AS objectLevel,
       amh.path        AS pathToObject
FROM tyva_schema.as_addr_obj aao
         FULL JOIN tyva_schema.as_mun_hierarchy amh ON aao.objectid = amh.objectid
WHERE aao.name ILIKE '%' || ? || '%'
  AND (aao.isactive = 1 AND aao.isactual = 1)
ORDER BY aao.level;


-- поиск aao.name @@ websearch_to_tsquery(?)
SELECT aao.typename    AS objectType,
       aao.name        AS objectName,
       aao.objectid    AS objectID,
       aao.objectguid  AS objectGUID,
       amh.parentobjid AS objectParent,
       aao.isactive    AS objectActiveStatus,
       aao.isactual    AS objectActualStatus,
       aao.level       AS objectLevel,
       amh.path        AS pathToObject
FROM tyva_schema.as_addr_obj aao
         FULL JOIN tyva_schema.as_mun_hierarchy amh ON aao.objectid = amh.objectid
WHERE aao.name @@ websearch_to_tsquery(?)
  AND (aao.isactive = 1 AND aao.isactual = 1)
ORDER BY aao.level;


select aao.typename    AS objectType,
       aao.name        AS objectName,
       aao.objectid    AS objectID,
       aao.objectguid  AS objectGUID,
       amh.parentobjid AS objectParent,
       aao.isactive    AS objectActiveStatus,
       aao.isactual    AS objectActualStatus,
       aao.level       AS objectLevel,
       amh.path        AS pathToObject
from tyva_schema.as_addr_obj aao
         inner join tyva_schema.as_mun_hierarchy amh on aao.objectid = amh.objectid
where aao.objectid = 206101
   or (aao.objectid = 95235322 and aao.isactual = 1 and aao.isactive = 1)
   or (aao.objectid = 95235329 and aao.isactual = 1 and aao.isactive = 1)
   or aao.objectid = 209801
   or aao.objectid = 210093
order by aao.level;


-- решение через рекурсию

WITH RECURSIVE child_to_parents AS (
    SELECT aah.objectid, aah.parentobjid, aah.isactive, aah.path, aao2.typename, aao2.name
    FROM tyva_schema.as_adm_hierarchy aah
        FULL JOIN tyva_schema.as_addr_obj aao2 ON aao2.objectid = aah.objectid
    WHERE aah.isactive = 1
        AND aah.objectid IN (
            SELECT DISTINCT aao.objectid
                FROM tyva_schema.as_addr_obj aao
                    WHERE aao.name ILIKE '%' || ? || '%'
                        AND aao.isactive = 1
                        AND aao.isactual = 1
    )
    UNION ALL
    SELECT DISTINCT aah2.objectid, aah2.parentobjid, aah2.isactive, aah2.path, aao3.typename, aao3.name
    FROM tyva_schema.as_adm_hierarchy aah2, tyva_schema.as_addr_obj aao3, child_to_parents
    WHERE aah2.objectid = child_to_parents.parentobjid
        AND aah2.streetcode != 0
)
